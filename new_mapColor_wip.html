<!DOCTYPE html>
<meta charset="utf-8">
<style>

  //.countries {
  fill: BurlyWood;
  stroke: black;
  stroke-width:0.1px;
  }

  .countries {
  stroke: black;
  stroke-width:0.1px;
  }

  .countries:hover{
  fill: GoldenRod;
  }
  
  .internship:hover{
  fill: DarkGreen;
  }

  .internship {
  fill: BlueViolet;
  opacity:0.5;
  }

  
  div.tooltip {   
  position: absolute;           
  text-align: center;           
  width: 90px;                  
  height: 80px;                 
  padding: 2px;             
  font: 12px sans-serif;        
  background: lightsteelblue;   
  border: 0px;      
  border-radius: 8px;           
  pointer-events: none;         
  }


  .background {
  fill: CornFlowerBlue;
  pointer-events: all;
  }
  
  .button {
	  fill: Green;
	  stroke: black;
	  stroke-width:0.5px;
  }
  
 
  
  </style>
<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v0.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>

  <script>

    //On commence par déclarer toutes nos variables

    //On ajoute un div au body. Le div du html va ainsi pouvoir contenir notre tooltip
    
    var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);
    

	

    //Variables qui définissent les dimensions de l'image
    var width = 1400,
    height = 800;
    
    var button_width = 20,
    button_height = 20;
    
    // La variable projection pour projeter les données sur la carte.  
    var projection = d3.geo.mercator()
    .center([10, 70 ])
    .scale(150)
    .rotate([0,0]);
    

    //Création de l'image au format SVG
    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
  


    //On ajoute à notre image un rectangle qui sera notre fond bleu
    svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);
    


    
    //L'objet path permet de manipuler les données géographiques de nos fichiers GeoJson
    //En fait, path (=chemin) permet de dessiner le contour de nos objets.
    var path = d3.geo.path()
    .projection(projection);

    

    //Variable g, qui permet de grouper les éléments de l'image SVG
    var g = svg.append("g");


    //Fonction qui permet de charger les données dans l'ordre où on place nos fichiers GeoJson
    queue()
    .defer(d3.json, "world.json")
    .defer(d3.json, "internship_auto.json")
    .await(makeMyMap);


    //fonction qui créee la map en fonction des données qu'on a chargé précedemment
    function makeMyMap(error, countries, internship) {

    //On s'occupe des pays du fichier World.json
    g.selectAll(".countries")
    .data(topojson.object(countries, countries.objects.countries).geometries)
    .enter()
    .append("path")
    .attr("d", path)
    .attr("class", "countries")
    	.attr("fill", couleur)
	.on("mouseout", mouseout)
    .on("mouseover", mouseover)
    .on("mousemove",  function(d) {

	
    var compteur;
    for (var i = 0; i < creation_compteurs.length; i++) {
			if (d.properties.name == creation_compteurs[i].key) {
			compteur = creation_compteurs[i].values.length;
			break;
			return compteur;
			}
			else {
			compteur = 0;
			}
			}
	

			
     
//Ca c'est ce qui s'affiche dans la fenêtre au passage de la souris
    div.html(d.properties.name  + "<br/>" + "compteur " + compteur )
    .style("left", (d3.event.pageX) + "px")
    .style("top", (d3.event.pageY - 50) + "px");
    });

			

			
   

			
		
			function couleur(d) {

			
			var creation_compteurs = d3.nest()
			.key(function(d) { return d.properties.country; })
			.key(function(d) { return d.properties.id; })
			.rollup(function(leaves) { return leaves.length; })
			.entries(internship.features);

			
			
			
			var compteur_couleur;
			var color = "DarkGreen";
			for (var i = 0; i < creation_compteurs.length; i++) {
					    if (d.properties.name == creation_compteurs[i].key) {
					    color = "white";
					    return color;					    
					    }						  
					    }
					    return color;
					    }
			   


    //On s'occupe des stages de internship.json
    g.selectAll(".internship") //Ici, on sélectionne tous les objets qu'on va créer (pas clair)
    .data(internship.features) //On spécifie les données que l'on souhaite au sein du fichier json.
    .enter()//Là, on crée des espaces reservés pour chaque entrée spécifiée auparavant.
    .append("path")// Puis on ajoute un élément dans chacun des espaces réservés crées précedemment.
    .attr("d", path.pointRadius(2))//On envoie les données (d) à path qui s'occupe de dessiner les coutours des objets, de les représenter donc.
    //On décide de représenter les objets par des points dont on spécifie le rayon.
    .attr("class", "internship")//On définit un attribut class dont la valeur est internship pour tous nos objets.
    .on("mouseover", mouseover) //Fonction
    .on("mousemove", mousemove) //Fonction
    .on("mouseout", mouseout); //Fonction

    //creation of the buttons "per year"

	g.append("rect")
    .attr("class", "button")
    .attr("id", "2013")
    .attr("x", 0)
    .attr("y", 0)
    .attr("width", button_width)
    .attr("height", button_height)
    .on("click", change);
    
    g.append("rect")
    .attr("class", "button")
    .attr("id", "2014")
    .attr("x", 0)
    .attr("y", 50)
    .attr("width", button_width)
    .attr("height", button_height)
    .on("click", change);
    

	// pour tout supp: g.selectAll(".internship").remove();
	// d3.select("#internship2015");
	// Object.keys(d3.select("#internship2015")[0][0]) renvoie:  Array [ "0", "parentNode" ]
	// Object.getOwnPropertyNames(d3.select("#internship2015")[0][0]) ??
	// g.selectAll(".internship")[0][0].id renvoie bien l'id
	// console.log(Object.keys(document.getElementById('2015'))); renvoie Array [ "__onclick" ]
	
	// interessant: Object.getOwnPropertyNames(d3.selectAll(".internship")[0][0]) donne Array [ "__data__", "__onmouseover", "__onmousemove", "__onmouseout" ]
    // d3.selectAll(".internship")[0][0].__data__ donne:  Object { type: "Feature", geometry: Object, properties: Object }
    // d3.selectAll(".internship")[0][1].__data__.properties.year renvoie l'année
    // if d3.selectAll(".internship")[0][1].__data__.properties.year=="2016".remove()
    
     function change() {
		if (document.getElementById('2013').style.fill != "Red"){
			document.getElementById('2013').style.fill = "Red";
			var i=0;
			while (i!=d3.selectAll(".internship")[0].length-1) {
				//console.log("je regarde  un stage de  " + (d3.selectAll(".internship")[0][i].__data__.properties.year));
				//console.log("le suivant sera de  " + (d3.selectAll(".internship")[0][i+1].__data__.properties.year));
				if (d3.selectAll(".internship")[0][i].__data__.properties.year == "2013"){
					//console.log("l'actuel est de 2013, je retire");
					d3.selectAll(".internship")[0][i].remove()
				}
				if (d3.selectAll(".internship")[0][i].__data__.properties.year != "2013"){
					//console.log("il n'est pas de 2013, je je passe au suivant");
					i++;
				}
		}
		return "Red";
	}
		if (document.getElementById('2015').style.fill != "Green"){
			document.getElementById('2015').style.fill = "Green";
			return "Green";
		}
	}

/*     ancienne version de change, au cas ou.
		function change() {
		if (document.getElementById('2015').style.fill != "Red"){
			document.getElementById('2015').style.fill = "Red";
			for (var i=0; i < 49; i++) {
				console.log("c'est detecte");
				console.log("test: " + (d3.selectAll(".internship")[0][i]));
				console.log("test: " + (d3.selectAll(".internship")[0][i].__data__.properties.year));
				if (d3.selectAll(".internship")[0][i].__data__.properties.year == "2016"){
					if (d3.selectAll(".internship")[0][i+1].__data__.properties.year == "2016"){
						g.selectAll(".internship")[0][i].remove();
						i=i-1;
				}
		}
	}
	return "Red";
		if (document.getElementById('2015').style.fill != "Green"){
			document.getElementById('2015').style.fill = "Green";
			return "Green";
		}
	}*/


    //Création des compteur de stages pour chaque pays.
    //Utilisation de la fonction nest qui permet de grouper les données comme on le souhaite.
    //Ici, on regroupe tous les id en fonction de leur pays.
    //Un id identifie un stage de manière unique.
    
    var creation_compteurs = d3.nest()
    .key(function(d) { return d.properties.country; })
    .key(function(d) { return d.properties.id; })
    .rollup(function(leaves) { return leaves.length; })
    .entries(internship.features);

    //La longeur de la liste d'id pour un pays correspond au nombre de stages effectués dans ce pays.
    
    var compteurUK = creation_compteurs[0].values.length;
    var compteurUK_2015 = creation_compteurs[0].values[0].values;
    var compteurUK_2016 = creation_compteurs[0].values[1].values;
    var country = creation_compteurs[0].key;

    
    console.log(creation_compteurs)
    console.log("stages en UK:  " + compteurUK)
    console.log("stages en UK en 2015: " + compteurUK_2015)
    console.log("stages en UK en 2016: " + compteurUK_2016)
    console.log("Quel pays? " + country)
    

    
    }

    //Le zoom.
    
    var zoom = d3.behavior.zoom()
    .on("zoom",function() {
    g.attr("transform","translate("+ 
    d3.event.translate.join(",")+")scale("+d3.event.scale+")");


    
    });
    
    svg.call(zoom)
   

    
    //fonctions de comportement des éléments de l'image au passage de la souris.


    
    
    function mouseover(){
    div.transition()
    .duration(200)
    .style("opacity", .9);
    }
    
    function mousemove(d){
    div.html("ville: " + d.properties.city  + "<br/>" + "année: " + d.properties.year )
    .style("left", (d3.event.pageX) + "px")
    .style("top", (d3.event.pageY - 50) + "px");
    }
 
    function mouseout(){
    div.transition()
    .duration(500)
    .style("opacity", 0);
}




   //Compteur année.
    var creation_compteurs = d3.nest()
    .key(function(d) { return d.properties.Pays; })
    .key(function(d) { return d.properties.year; })
    .rollup(function(leaves) { return leaves.length; })
    .entries(internship.features);
    
    var compteurUK = creation_compteurs[0].values.length;
    var compteurUK_2015 = creation_compteurs[0].values[0].values;
    var compteurUK_2016 = creation_compteurs[0].values[1].values;
    var pays = creation_compteurs[0].key;

    
    console.log(creation_compteurs)
    


  </script>
</body>
</html>ages en UK:  " + compteurUK)
    console.log("stages en UK en 2015: " + compteurUK_2015)
    console.log("stages en UK en 2016: " + compteurUK_2016)
    console.log("Quel pays? " + country)


    				    
		    
